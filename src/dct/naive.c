#include "dct/naive.h"

#define PI 3.141592653589793
#define SQRT_2_INV 0.707106781186547524400844362104849039284835937688474036588
#define ROUND_NEAREST 0.5

// 32-element lookup table.
// cos_lookup[x] == cos(x * pi / 16)
const double cos_lookup[32] =
{
    1.0, // cos(0)
    0.980785280403230449126182236134239036973933730893336095002, // pi/16
    0.923879532511286756128183189396788286822416625863642486115, // 2pi/16
    0.831469612302545237078788377617905756738560811987249963446, // 3pi/16
    0.707106781186547524400844362104849039284835937688474036588, // 4pi/16
    0.555570233019602224742830813948532874374937190754804045924, // 5pi/16
    0.382683432365089771728459984030398866761344562485627041433, // 6pi/16
    0.195090322016128267848284868477022240927691617751954807754, // 7pi/16
    0.0, // cos(pi/2)
    -0.195090322016128267848284868477022240927691617751954807754, // 9pi/16
    -0.382683432365089771728459984030398866761344562485627041433, // 10pi/16
    -0.555570233019602224742830813948532874374937190754804045924, // 11pi/16
    -0.707106781186547524400844362104849039284835937688474036588, // 12pi/16
    -0.831469612302545237078788377617905756738560811987249963446, // 13pi/16
    -0.923879532511286756128183189396788286822416625863642486115, // 14pi/16
    -0.980785280403230449126182236134239036973933730893336095002, // 15pi/16
    -1.0, // cos(pi)
    -0.980785280403230449126182236134239036973933730893336095002,
    -0.923879532511286756128183189396788286822416625863642486115,
    -0.831469612302545237078788377617905756738560811987249963446,
    -0.707106781186547524400844362104849039284835937688474036588,
    -0.555570233019602224742830813948532874374937190754804045924,
    -0.382683432365089771728459984030398866761344562485627041433,
    -0.195090322016128267848284868477022240927691617751954807754,
    0.0, // cos(3pi/2)
    0.195090322016128267848284868477022240927691617751954807754,
    0.382683432365089771728459984030398866761344562485627041433,
    0.555570233019602224742830813948532874374937190754804045924,
    0.707106781186547524400844362104849039284835937688474036588,
    0.831469612302545237078788377617905756738560811987249963446,
    0.923879532511286756128183189396788286822416625863642486115,
    0.980785280403230449126182236134239036973933730893336095002
};

// input: 8x8 array, output: 8x8 array.
// only optimization is the cosine lookup table.
void dct_naive(const int8_t data_in[8][8], int8_t data_out[8][8])
{
    // X(u,v) = (C(u)/2)*(C(v)/2) * sigma[i=0 to 7]( sigma[j=0 to 7]( x(i,j)*cos((2i+1)*u*pi/16)*cos((2j+1)*v*pi/16) ) )
    for (int u = 0; u < 8; ++u)
    {
        double c_u = u == 0 ? SQRT_2_INV : 1.0;
        for (int v = 0; v < 8; ++v)
        {
            double c_v = v == 0 ? SQRT_2_INV : 1.0;
            double outer_sum = 0;
            for (int i = 0; i < 8; ++i)
            {
                double inner_sum = 0;
                double cos_u = cos_lookup[((2*i + 1) * u) % 32];
                for (int j = 0; j < 8; ++j)
                {
                    double cos_v = cos_lookup[((2*j + 1) * v) % 32];
                    inner_sum += data_in[i][j] * cos_u * cos_v;
                }
                outer_sum += inner_sum;
            }
            // NB: this result could be outside [-128, 127]; it will fail in that case.
            data_out[u][v] = (int8_t) (c_u * c_v * outer_sum + ROUND_NEAREST);
        }
    }
}